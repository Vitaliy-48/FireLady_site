<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–ö–∞—Ç–∞–ª–æ–≥ —Å–≤—ñ—á–æ–∫</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
    <header>
        <h1>–ö–∞—Ç–∞–ª–æ–≥</h1>
        <nav>
            <ul>
                <li><a href="/">–ì–æ–ª–æ–≤–Ω–∞</a></li>
                <li><a href="/checkout">–ö–æ—à–∏–∫</a></li>
            </ul>
        </nav>
    </header>

    <section id="products">
        <h2>–ù–∞—à—ñ —Å–≤—ñ—á–∫–∏</h2>
        {% for product in products %}
            <div class="product">
                <img src="{{ url_for('static', filename='images/' + product.image) }}" class="img-fluid rounded" width="100">
                <p id="product-title-{{ product.id }}"></p>
                <p>{{ product.price }} –≥—Ä–Ω</p>
                <div class="input-group w-50">
                    <input type="number" name="quantity-{{ product.id }}" min="1" value="1" class="form-control">
                    <span class="input-group-text">—à—Ç.</span>
                </div>


                <!-- –§–æ—Ä–º–∞ –≤–∏–±–æ—Ä—É –∫–æ–ª—å–æ—Ä—É -->
                <form class="color-selection">
                    <label>–û–±–µ—Ä—ñ—Ç—å –∫–æ–ª—ñ—Ä:</label>
                    {% for hex, namec in colors.items() %}
                        <input type="radio" name="color-{{ product.id }}" value="{{ hex }}" id="color-{{ product.id }}-{{ hex }}" style="display: none;">
                        <label for="color-{{ product.id }}-{{ hex }}" style="
                            background-color: {{ namec.hex }};
                            width: 20px;
                            height: 20px;
                            display: inline-block;
                            border-radius: 50%; /* –†–æ–±–∏—Ç—å —Ñ–æ—Ä–º—É –∫—Ä—É–≥–ª–æ—é */
                            border: 2px solid #ccc; /* –î–æ–¥–∞—î —Ä–∞–º–∫—É –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç—ñ */
                            cursor: pointer;
                        "></label>
                    {% endfor %}
                </form>


                <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –¥–æ –∫–æ—à–∏–∫–∞ -->
                <button class="add-to-cart" data-id="{{ product.id }}">–î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫</button>
            </div>
        {% endfor %}
    </section>

    <!-- JavaScript –∫–æ–¥ -->
    <script>
        document.querySelectorAll(".product").forEach(productDiv => {
            const productId = productDiv.querySelector(".add-to-cart").dataset.id;
            const colorInputs = productDiv.querySelectorAll(`input[name='color-${productId}']`);
            const addToCartBtn = productDiv.querySelector(".add-to-cart");
            const titleEl = document.getElementById(`product-title-${productId}`);
            const colorData = {{ colors | tojson }};

            const defaultColor = Object.keys(colorData)[0];
            const defaultColorName = colorData[defaultColor]?.name || "–ë—ñ–ª–∏–π";
            let selectedColor = defaultColor;

            // üîπ –°—Ç–≤–æ—Ä—é—î–º–æ —Ç–µ–∫—Å—Ç —ñ –º–∞—Ä–∫–µ—Ä —è–∫ –æ–∫—Ä–µ–º—ñ –µ–ª–µ–º–µ–Ω—Ç–∏
            const titleText = document.createElement("span");
            titleText.textContent = `–°–≤—ñ—á–∫–∞ #${productId}-1 (${defaultColorName})`;

            const colorMarker = document.createElement("label");
            colorMarker.setAttribute("style", `
                background-color: ${defaultColor};
                width: 20px;
                height: 20px;
                display: inline-block;
                border-radius: 50%;
                border: 2px solid #ccc;
                cursor: pointer;
                margin-left: 8px;
                vertical-align: middle;
            `);
            colorMarker.setAttribute("for", `color-${productId}-${defaultColor}`);

            titleEl.appendChild(titleText);
            titleEl.appendChild(colorMarker);

            // üîπ –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –±—ñ–ª–∏–π —è–∫ –ø–æ—á–∞—Ç–∫–æ–≤–∏–π –æ–±—Ä–∞–Ω–∏–π
            const defaultInput = productDiv.querySelector(`input[name='color-${productId}'][value='${defaultColor}']`);
            if (defaultInput) defaultInput.checked = true;

            // üîπ –ü—Ä–∏ –∑–º—ñ–Ω—ñ –∫–æ–ª—å–æ—Ä—É ‚Äî –æ–Ω–æ–≤–ª—é—î–º–æ —Ç–µ–∫—Å—Ç —ñ –∫–æ–ª—ñ—Ä –º–∞—Ä–∫–µ—Ä–∞
            colorInputs.forEach(input => {
                input.addEventListener("change", () => {
                    selectedColor = input.value;
                    const colorName = colorData[selectedColor]?.name || selectedColor;

                    titleText.textContent = `–°–≤—ñ—á–∫–∞ ${productId}-${selectedColor} (${colorName})`;
                    const newHex = colorData[selectedColor]?.hex || "#ffffff";
                    colorMarker.style.backgroundColor = newHex;

                    colorMarker.setAttribute("for", `color-${productId}-${selectedColor}`);

                    titleEl.classList.add("pulse");
                    setTimeout(() => titleEl.classList.remove("pulse"), 500);
                });
            });

            // üîπ –û–±—Ä–æ–±–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤ –∫–æ—à–∏–∫
            addToCartBtn.addEventListener("click", () => {
                const selectedInput = productDiv.querySelector(`input[name='color-${productId}']:checked`);
                const quantityInput = productDiv.querySelector(`input[name='quantity-${productId}']`);

                if (!selectedInput) {
                    alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –∫–æ–ª—ñ—Ä –ø–µ—Ä–µ–¥ –¥–æ–¥–∞–≤–∞–Ω–Ω—è–º —É –∫–æ—à–∏–∫.");
                    return;
                }

                const color = selectedInput.value;
                const quantity = quantityInput ? parseInt(quantityInput.value, 10) : 1;

                addToCartBtn.classList.add("btn-warning", "pulse");
                setTimeout(() => {
                    addToCartBtn.classList.remove("btn-warning", "pulse");
                    addToCartBtn.classList.add("btn-primary");
                }, 500);

                fetch("/add-to-cart", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        id: productId,
                        color_id: selectedColor,
                        color_name: colorData[selectedColor]?.name || "–ù–µ–≤—ñ–¥–æ–º–∏–π –∫–æ–ª—ñ—Ä",
                        color_hex: colorData[selectedColor]?.hex,
                        quantity: quantity
                    })
                })
                .then(response => response.json())
                .then(data => console.log("–û–Ω–æ–≤–ª–µ–Ω–∏–π –∫–æ—à–∏–∫:", data))
                .catch(error => console.error("–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤ –∫–æ—à–∏–∫:", error));
            });
        });

        // üîπ –±–ª–æ–∫ –æ–±—Ä–æ–±–∫–∏ –≤—Å—ñ—Ö –ø–æ–ª—ñ–≤ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ (input[type=number])

        document.querySelectorAll("input[type=number]").forEach(input => {
            input.addEventListener("mouseleave", () => {
                input.blur(); // –∑–Ω—ñ–º–∞—î —Ñ–æ–∫—É—Å ‚Üí —Å–∏–Ω—ñ–π –∫–æ–Ω—Ç—É—Ä –ø—Ä–æ–ø–∞–¥–∞—î
            });
        });
    </script>

</body>
</html>